<!DOCTYPE html>
<html>
<head>	
    <script type="text/javascript">
    function quantitychanged()
    {
        alert("quantitychanged now");

        $id = $.trim($(this).attr('id'));
        $qn = $.trim($(this).val());
        console.log('/shoppingcart/updateshoppingcartquantity?shopping_cart_det_id='+$id+'&new_quantity='+$qn);

        $.post('/shoppingcart/updateshoppingcartquantity?shopping_cart_det_id='+$id+'&new_quantity='+$qn , {'message' : $id},
                function (respond) { 
                console.log($id);   
                console.log(respond);              
                }
        );
    }


    function paybillwithemail()
    {
        var coupon_id = $('#coupon_id').val();
        var message = $('#coupon').val();
        console.log("message is " + message);
        if(coupon_id)
        {
          $.post('/shoppingcart/checkout/coupon_id/'+ coupon_id , {'message' : message},
            function (respond) {
              $(".show-msg").html("Donnneee"); 
              $("#CongratsButton").click();
            }
          );
        }
        else
        {
           $.post('/shoppingcart/checkout' , {'message' : message},
            function (respond) {

            }
          );
        }
               
    }

    function verifycoupon()
    {
            var message = $('#coupon').val();
            if (message != '') {
              $.post('/coupon/validate/c_hash/'+ $('#coupon').val() + '', {'message' : message},
                function (respond) {                         
                  $(".show-msg").html((respond.split("|")[0]).trim()); 
                  $('input#coupon_id').val((respond.split("|")[1]).trim());
                  checkouttourl();             
                }
              );              
            }
    }

    function checkouttourl()
    {
      var coupon_id = $('#coupon_id').val();
      console.log(coupon_id);
      if(coupon_id)
      {
          $("#confirmCheckOut").attr("href","/shoppingcart/checkout/coupon_id/" + coupon_id);
      }
      else
      {
          $("#confirmCheckOut").attr("href","/shoppingcart/checkout");
      }
    }


    </script>
	<title></title>
</head>
<body>
<div class="container">

	<h1> Shopping Cart (<?php echo sizeof($this->all_cart_details); ?>)</h1>
	<br/>

	<?php 
	foreach ($this->all_cart_details as $key => $value) {
		echo '<div class="jumbotron">';
    echo '<input id="shoppingcartid" type="hidden" value="'.$value['shopping_cart_det_id'].'"/>';
		echo '<h2>' . $value['name_en'] .'</h2>';
		echo '<p>' . $value['description_en'] . '</p>';
		echo '<p><a class="btn btn-primary btn-lg" href="/products/details/product_id/' . $value['product_id']. '"'. ' role="button">' . 'Go to product details' . '</a>'  ;

		echo '<p><a class="btn btn-danger btn-lg" href="removeitemfromcart?shopping_cart_det_id=' . $value['shopping_cart_det_id']. '"'. ' role="button">' . 'Remove Item Cart' . '</a>'  ;

    // echo '<p> Quantity: <input type="text" id="'.$value['shopping_cart_det_id'].'" onchange="quantitychanged.call(this,event);" value="'.$value['quantity'].'"'. '/></p>';

?>

<p> Quantity:

<select id="<?= $value['shopping_cart_det_id'] ?>" onchange="quantitychanged.call(this,event);" >
    <option value="1" <?=$value['quantity'] == '1' ? ' selected="selected"' : '';?>>1</option>
    <option value="2" <?=$value['quantity'] == '2' ? ' selected="selected"' : '';?>>2</option>
    <option value="3" <?=$value['quantity'] == '3' ? ' selected="selected"' : '';?>>3</option>
    <option value="4" <?=$value['quantity'] == '4' ? ' selected="selected"' : '';?>>4</option>
    <option value="5" <?=$value['quantity'] == '5' ? ' selected="selected"' : '';?>>5</option>
</select>

</p>


<?php 
		echo '</div>';
	}
	?>

</div>
<center><button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#CheckOutModal">Check Out Now..</button></center>

<!-- Modal -->
<div id="CheckOutModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Check Out Your Shopping Cart</h4>
      </div>
      <div class="modal-body">    
        <div class="show-msg"></div>
        <p>
        <?php 
//        $shopping_cart_model = new Application_Model_Shoppingcart();
//        $shopping_cart_details =  $shopping_cart_model->getUserShoppingCart($_SESSION['customer_id']); 
//
//        $total_amount = $shopping_cart_details["total_amount"];
//        $total_discount = $shopping_cart_details["discount"];
//        $net_amount = $shopping_cart_details["total_amount"] - $shopping_cart_details["discount"];
        ?>
      <div class="form-group">
        <label for="totalAmount">Total Amount : <?php echo $total_amount; ?></label>
      </div>

      <div class="form-group">
        <label for="discount">Discount from Offer : <?php echo $total_discount; ?></label>
      </div>


      <div class="form-group">
        <label for="dueamount">Net Amount : <?php echo $net_amount; ?></label>
      </div>
      <input type="hidden" id="coupon_id" name="coupon_id">
      <div class="form-group">
        <label for="discount">Due Amount (After Coupon) : <?php echo $net_amount; ?></label>
      </div>
        <input type="text" id="coupon" name="coupon" class="form-control" placeholder="OR Use a Coupon">
      </div>


      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
        <button id="verifybutton" type="button" class="btn btn-default" onclick="verifycoupon()" >Verify</button>  

        <a onclick="paybillwithemail()" id="confirmCheckOut" href="" class="btn btn-primary"> Confirm Checkout </a>        
      </div>
    </div>

  </div>
</div>

</body>
</html>
